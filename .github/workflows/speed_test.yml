name: speed_test

on:
  schedule:
    - cron: '0 2 */3 * *'  # 每3天的凌晨10点（UTC）= 下午6点（北京时间）执行
  workflow_dispatch:  # 支持手动触发

env:
  TZ: Asia/Shanghai
  PYTHON_VERSION: '3.10'
  TARGET_REPO: "Lei9008/IPTV"

jobs:
  merge-and-push-iptv:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码（清空默认凭证，避免权限问题）
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # 关键：清空默认的 github-actions[bot] 凭证

      # 步骤2：设置Python环境
      - name: Set Up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # 缓存pip依赖，加快后续运行速度

      # 步骤3：安装Python依赖（修复：补充aiohttp）
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests aiohttp

      # 步骤4：执行IPTV脚本（优化：省略冗余的working-directory）
      - name: Run IPTV Merge Script
        run: python main/iptv_processor_core.py

      # 步骤5：配置Git用户信息
      - name: Configure Git User
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

      # 步骤6：更新Git远程地址（带PAT）并拉取最新代码
      - name: Force Update Git Remote with PAT
        env:
          IPTV_PUSH_TOKEN: ${{ secrets.IPTV_PUSH_TOKEN }}
        run: |
          # 移除并重新添加远程仓库（带个人访问令牌PAT）
          git remote rm origin
          git remote add origin https://${IPTV_PUSH_TOKEN}@github.com/${{ env.TARGET_REPO }}.git
          # 打印远程地址确认
          echo "=== Current Git Remote ==="
          git remote -v
          # 拉取最新代码，若无变更则忽略错误
          git pull origin main --rebase || echo "No remote changes to pull or rebase failed, continue to push"

      # 步骤7：提交并推送结果（优化：补充时间戳、可选强制推送）
      - name: Commit and Push
        run: |
          git add -A
          if ! git diff --staged --quiet; then
            # 优化：添加时间戳，便于追溯
            git commit -m "Auto-merge IPTV sources: Update Live_iptv.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
            # 普通推送（优先推荐，无冲突时使用）
            git push origin main
            # 若需强制覆盖（谨慎使用！会覆盖远程最新提交），替换上面一行为：
            # git push origin main --force
            echo "Push success!"
          else
            echo "No changes to push"
          fi
